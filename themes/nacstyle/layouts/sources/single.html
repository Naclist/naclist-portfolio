{{ define "main" }}
<main class="flex flex-col items-center justify-center px-4 py-8 text-center">
  <h1 class="text-3xl font-semibold mb-6">Dynamics of 2.5 in China</h1>

  <div class="bg-gray-100 border border-gray-300 rounded-2xl shadow-sm p-6 flex flex-col items-center"
       style="max-width:520px;margin:0 auto;">

    <!-- 画布 -->
    <div id="viewer"
         style="position:relative;width:90%;max-width:400px;aspect-ratio:4/3;
                border-radius:12px;background:#fff;border:1px solid #ccc;
                display:flex;align-items:center;justify-content:center;
                cursor:pointer;margin:0 auto 20px;">
      <img id="imgA" style="position:absolute;width:100%;height:100%;object-fit:contain;opacity:0;transition:opacity .6s ease-in-out;" />
      <img id="imgB" style="position:absolute;width:100%;height:100%;object-fit:contain;opacity:0;transition:opacity .6s ease-in-out;" />
    </div>

    <!-- 控制区 -->
    <div class="w-full" style="width:90%;display:grid;grid-template-columns:5% 80% 5% 5%;align-items:center;">
      <div></div>
      <input type="range" id="yearSlider" min="2009" max="2024" step="1" value="2009"
             style="width:100%;appearance:none;height:6px;border-radius:3px;
                    background:linear-gradient(to right,#3b82f6 0%,#3b82f6 0%,#d1d5db 0%,#d1d5db 100%);
                    outline:none;margin:0;"/>
      <div></div>
      <button id="playBtn"
              style="width:100%;height:30px;background:none;border:none;
                     cursor:pointer;display:flex;align-items:center;justify-content:center;
                     color:#3b82f6;transition:color .2s;">
        <svg id="btnIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
             width="20" height="20" fill="currentColor">
          <path d="M8 5v14l11-7z"/>
        </svg>
      </button>
    </div>

    <!-- 时间刻度 -->
    <div class="w-full" style="width:90%;display:grid;grid-template-columns:5% 80% 5% 5%;margin-top:6px;">
      <div></div>
      <div id="yearTicks"
           style="display:flex;justify-content:space-between;
                  font-size:.7rem;color:#b0b0b0;letter-spacing:.5px;"></div>
      <div></div><div></div>
    </div>
  </div>
</main>
{{ end }}

{{ define "scripts" }}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const IMG_DIR = '{{ "sources/ab_china_dynamics_source/figures" | relURL }}';
  const slider = document.getElementById('yearSlider');
  const imgA = document.getElementById('imgA');
  const imgB = document.getElementById('imgB');
  const playBtn = document.getElementById('playBtn');
  const btnIcon = document.getElementById('btnIcon');
  const ticksBox = document.getElementById('yearTicks');
  const viewer = document.getElementById('viewer');
  let currentImg = imgA;

  const minYear = Number(slider.min), maxYear = Number(slider.max);
  const years = Array.from({ length: maxYear - minYear + 1 }, (_, i) => minYear + i);
  const yearToFile = y => `${IMG_DIR}/${y === 2009 ? 'less_than_2010' : y}.png`;
  const yearToLabel = y => y === 2009 ? '<2010' : `${y}`;

  years.forEach(y => { const img = new Image(); img.src = yearToFile(y); });

  const majorYears = [2010, 2015, 2020, 2024];
  for (let y = minYear; y <= maxYear; y++) {
    const sp = document.createElement('span');
    sp.className = 'tick';
    sp.dataset.year = y;
    sp.textContent = majorYears.includes(y) ? `${y}` : '•';
    ticksBox.appendChild(sp);
  }

  function highlightTick(activeYear) {
    document.querySelectorAll('.tick').forEach(t => {
      const y = Number(t.dataset.year);
      if (y === activeYear) {
        t.style.color = '#000';
        t.style.fontWeight = '700';
        t.style.textShadow = '0 0 4px rgba(0,0,0,0.15)';
      } else {
        t.style.color = '#b0b0b0';
        t.style.fontWeight = '400';
        t.style.textShadow = 'none';
      }
    });
  }

  function updateSliderFill(val) {
    const pct = ((val - minYear) / (maxYear - minYear)) * 100;
    slider.style.background = `linear-gradient(to right,#3b82f6 0%,#3b82f6 ${pct}%,#d1d5db ${pct}%,#d1d5db 100%)`;
  }

  function crossfadeTo(src) {
    const nextImg = currentImg === imgA ? imgB : imgA;
    nextImg.src = src;
    nextImg.onload = () => {
      nextImg.style.opacity = '1';
      currentImg.style.opacity = '0';
      currentImg = nextImg;
    };
  }

  function updateFrame(val) {
    const y = Number(val);
    updateSliderFill(y);
    highlightTick(y);
    const targetSrc = yearToFile(y);
    if (!currentImg.src.endsWith(targetSrc)) crossfadeTo(targetSrc);
    document.title = `Dynamics of 2.5 — ${yearToLabel(y)}`;
  }

  slider.addEventListener('input', e => { updateFrame(e.target.value); stopAutoplay(); });

  let autoplay = false;
  let currentYear = minYear;
  let lastTime = 0;

  function animate(time) {
    if (!autoplay) return;
    const dt = time - lastTime;
    if (dt > 300) {
      currentYear = currentYear < maxYear ? currentYear + 1 : minYear;
      slider.value = currentYear;
      updateFrame(currentYear);
      lastTime = time;
    }
    requestAnimationFrame(animate);
  }

  function startAutoplay() {
    autoplay = true;
    btnIcon.innerHTML = '<rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/>';
    requestAnimationFrame(animate);
  }

  function stopAutoplay() {
    autoplay = false;
    btnIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
  }

  playBtn.addEventListener('click', () => { autoplay ? stopAutoplay() : startAutoplay(); });
  viewer.addEventListener('click', () => { autoplay ? stopAutoplay() : startAutoplay(); });

  const firstSrc = yearToFile(minYear);
  currentImg.src = firstSrc;
  currentImg.style.opacity = '1';
  updateFrame(minYear);
});
</script>
{{ end }}
